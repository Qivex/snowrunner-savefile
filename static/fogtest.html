<!DOCTYPE html>
<html>
<head>
	<title>Snowrunner Fog Test</title>
	<!-- From https://github.com/imaya/zlib.js -->
	<script src="lib/inflate.min.js"></script>
</head>
<body>
	<input id="files" type="file" accept=".cfg" multiple />
	<div id="preview"></div>
	<script>
		function log(msg) {
			console.log(Date.now(), msg)
		}

		function uncompressFile(blob, uncompressedSize) {
			return new Promise((resolve, reject) => {
				try {
					blob.arrayBuffer().then(buf => {
						const inflateTask = new Zlib.Inflate(new Uint8Array(buf), {bufferType: 0, bufferSize: uncompressedSize})
						resolve(new Blob([inflateTask.decompress()]))
					})
				} catch (e) {
					reject(e)
				}
			})
		}

		function decodeFogFile(blob) {
			return new Promise((resolve, reject) => {
				// 2x UInt32 for width and height of bitmap
				const sizeBlob = blob.slice(0,8)
				// Array of (width * height) bytes: 00 = Unexplored, 80 = Visible, FF = Explored
				const dataBlob = blob.slice(8, -16)
				// Transform blobs
				Promise.all([
					sizeBlob.arrayBuffer(),
					dataBlob.arrayBuffer()
				]).then((values) => {
					const size = new Uint32Array(values[0])
					const data = new Uint8ClampedArray(values[1])
					// TODO: These might be switched (check Island Lake/White Valley/Quarry)
					const width = size[0]
					const height = size[1]
					// Test if data has correct length
					const area = width * height
					console.assert(data.length === area, "Fog bitmap has wrong size")
					// Map data to RGBA (using .map(n=>[n,n,n,255]) with .flatmap(n=>n) was WAY slower - 300ms vs 2ms)
					let rgba = new Uint8ClampedArray(area * 4)
					let val
					for (let i=0; i<area; i++) {
						val = data[i]
						rgba[4*i+0] = val
						rgba[4*i+1] = val
						rgba[4*i+2] = val
						rgba[4*i+3] = 255
					}
					// Resolve as ImageData
					resolve(new ImageData(rgba, width))
				})
			})
		}

		const fileSelect = document.getElementById("files")
		const previewDiv = document.getElementById("preview")

		fileSelect.addEventListener("change", function() {
			previewDiv.innerHTML = ""
			for (const file of this.files) {
				const fileName = String(file.name)
				if (fileName.startsWith("fog_level_")) {
					log("Start " + fileName)
					// Find uncompressed size (used as buffer length during decode)
					file.slice(0, 4)
						.stream()
						.getReader()
						.read()
						.then(block => new Uint32Array(block.value.buffer)[0])
						.then(uncompressedSize => {
							// Decode remaining data using inflate
							const compressedData = file.slice(4)
							uncompressFile(compressedData, uncompressedSize)
								// Generate ImageData from Bitmap
								.then(uncompressedData => decodeFogFile(uncompressedData))
								// Generate ImageBitmap from ImageData
								.then(imageData => createImageBitmap(imageData))
								// Render using OffscreenCanvas & convert to PNG
								.then(imageBitmap => {
									let can = new OffscreenCanvas(imageBitmap.width, imageBitmap.height)
									let ctx = can.getContext("bitmaprenderer")
									ctx.transferFromImageBitmap(imageBitmap)
									return can.convertToBlob()	// PNG by default
								})
								// Append to body as image
								.then(pngBlob => {
									let img = document.createElement("img")
									img.height = 400
									img.title = fileName
									img.src = URL.createObjectURL(pngBlob)
									previewDiv.appendChild(img)
									log("Done  " + fileName)	// On my machine all 31 (up to S08) take 200ms
								})
						})
						.catch(error => console.log(error))
				}
			}
		})
	</script>
</body>
</html>